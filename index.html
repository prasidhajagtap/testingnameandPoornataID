<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Game | SharePoint Integrated</title>
    <style>
        :root { --dash-blue: #0056b3; --seamex-gray: #f4f7f9; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: transparent; margin: 0; padding: 15px; }
        .sync-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 5px solid var(--dash-blue); }
        .branding { font-size: 10px; color: #888; letter-spacing: 1px; margin-bottom: 10px; }
        .user-info { margin-bottom: 15px; }
        .label { font-size: 11px; color: var(--dash-blue); font-weight: bold; text-transform: uppercase; }
        .value { font-size: 16px; color: #333; font-weight: 600; margin-bottom: 8px; }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .active { background-color: #28a745; }
        .btn-play { background: var(--dash-blue); color: white; border: none; padding: 12px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; }
        #loader { font-size: 12px; color: #666; font-style: italic; }
    </style>
</head>
<body>

<div class="sync-container">
    <div class="branding">POWERED BY SEAMEX</div>
    
    <div id="loader">Syncing with Poornata Portal...</div>

    <div id="main-content" style="display:none;">
        <div class="user-info">
            <div class="label">Employee Name</div>
            <div id="sp-name" class="value">Loading...</div>
            
            <div class="label">Poornata ID</div>
            <div id="sp-id" class="value">Loading...</div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <span class="status-dot active"></span>
            <span style="font-size: 12px; color: #28a745;">Authenticated via ADFS</span>
        </div>

        <button class="btn-play" onclick="startGame()">ENTER DASH GAME</button>
    </div>
</div>

<script type="text/javascript">
    // 1. Wait for SharePoint libraries to load
    document.addEventListener("DOMContentLoaded", function() {
        if (typeof _spPageContextInfo !== "undefined") {
            fetchSharePointData();
        } else {
            document.getElementById('loader').innerText = "Error: Not running inside SharePoint.";
        }
    });

    function fetchSharePointData() {
        // A. Get Name directly from Page Context
        const userName = _spPageContextInfo.userDisplayName;
        const userLogin = _spPageContextInfo.userLoginName; // Usually domain\id

        // B. Fetch Employee ID from User Profile Service (REST API)
        const siteUrl = _spPageContextInfo.webAbsoluteUrl;
        const requestUrl = siteUrl + "/_api/SP.UserProfiles.PeopleManager/GetMyProperties";

        fetch(requestUrl, {
            headers: { "Accept": "application/json; odata=verbose" }
        })
        .then(response => response.json())
        .then(data => {
            const properties = data.d.UserProfileProperties.results;
            let poornataId = "Not Found";

            // Search for the specific Employee ID property (often called 'EmployeeID' or 'EmployeeNumber')
            properties.forEach(prop => {
                if (prop.Key === "EmployeeID" || prop.Key === "EmployeeNumber") {
                    poornataId = prop.Value;
                }
            });

            // If REST fails, try to strip ID from login name as fallback
            if (poornataId === "Not Found" && userLogin.includes('\\')) {
                poornataId = userLogin.split('\\')[1];
            }

            updateUI(userName, poornataId);
        })
        .catch(err => {
            console.error("Profile Fetch Error:", err);
            // Fallback for Name only
            updateUI(userName, "ID Pending");
        });
    }

    function updateUI(name, id) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        
        document.getElementById('sp-name').innerText = name;
        document.getElementById('sp-id').innerText = id;

        // Store for your game code to use later
        sessionStorage.setItem('dash_player_name', name);
        sessionStorage.setItem('dash_player_id', id);
    }

    function startGame() {
        // Logic to transition to your game canvas
        window.location.href = "game.html"; 
    }
</script>

</body>
</html>
